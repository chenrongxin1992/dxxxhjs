<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="/dxxxhjs/stylesheets/layui.css" media="all">
    <style type="text/css">
      /*.layui-input{
        width:85%!important;
        display: inline-block;
      }*/
      /*.layui-edge{
        display: none;
      }*/
    </style>
  </head>

  <body>
    <fieldset class="layui-elem-field">
      <legend>试卷设置详情</legend>
      <div class="layui-field-box">
        <form class="layui-form" action="">
          <div class="layui-form-item">
            <label class="layui-form-label">试卷主题</label>
            <div class="layui-input-block">
              <input type="text" name="ksname" id="ksname" class="layui-input" value="<%=detail.ksname%>" >
            </div>
          </div>
          <div class="layui-form-item">
              <label class="layui-form-label">考试时间</label>
              <div class="layui-input-inline">
                <input type="text" name="ksshijian" id="ksshijian" class="layui-input" value="<%=detail.ksshijian%>" lay-verify="ksshijian">
              </div>
              <div class="layui-form-mid layui-word-aux">分钟</div>
            <div class="layui-inline">
              <label class="layui-form-label">试题一致</label>
              <div class="layui-input-block">
                <select name="sjfs" id="sjfs" lay-filter="sjfs">
                    <%if(detail.sjfs==1){%>
                    <option value="<%=detail.sjfs%>" selected>是</option>
                    <option value="50">否</option>
                    <%}else{%>
                      <option value="<%=detail.sjfs%>" selected>否</option>
                      <option value="1">是</option>
                    <%}%>
                </select>
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <!-- <div class="layui-inline">
              <label class="layui-form-label">考试日期</label>
              <div class="layui-input-inline">
                <input type="text" name="ksriqi" id="ksriqi" class="layui-input" value="<%=detail.ksriqi%>">
              </div>
            </div> -->
            
            <div class="layui-inline">
            <label class="layui-form-label">是否启用</label>
              <div class="layui-input-block">
                <select name="youxiao" id="youxiao" lay-filter="youxiao">
                  <%if(detail.youxiao==1){%>
                    <option value="<%=detail.youxiao%>" selected>启用该考试</option>
                    <option value="0">禁用该考试</option>
                  <%}else{%>
                    <option value="<%=detail.youxiao%>" selected>禁用该考试</option>
                    <option value="1">启用该考试</option>
                  <%}%>
                </select>
              </div>
            </div>
            <div class="layui-inline">
            <label class="layui-form-label">当前考试</label>
              <div class="layui-input-block">
                <select name="dangqian" id="dangqian" lay-filter="dangqian">
                  <%if(detail.dangqian==1){%>
                    <option value="<%=detail.dangqian%>" selected>是</option>
                    <option value="0">否</option>
                  <%}else{%>
                    <option value="<%=detail.dangqian%>" selected>否</option>
                    <option value="1">是</option>
                  <%}%>
                </select>
              </div>
            </div>
          </div>
         
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">单选题数</label>
              <div class="layui-input-inline">
                <input type="text" name="danxuan_num" id="danxuan_num" class="layui-input" value="<%=detail.danxuan_num%>" lay-verify="danxuan_num">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">单选题分值</label>
              <div class="layui-input-inline">
                <input type="text" name="danxuan_fenzhi" id="danxuan_fenzhi" class="layui-input" value="<%=detail.danxuan_fenzhi%>" lay-verify="danxuan_fenzhi">
              </div>
              <div class="layui-form-mid layui-word-aux">分</div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">多选题数</label>
              <div class="layui-input-inline">
                <input type="text" name="duoxuan_num" id="duoxuan_num" class="layui-input" value="<%=detail.duoxuan_num%>" lay-verify="duoxuan_num">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">多选题分值</label>
              <div class="layui-input-inline">
                <input type="text" name="duoxuan_fenzhi" id="duoxuan_fenzhi" class="layui-input" value="<%=detail.duoxuan_fenzhi%>" lay-verify="duoxuan_fenzhi">
              </div>
              <div class="layui-form-mid layui-word-aux">分</div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">判断题数</label>
              <div class="layui-input-inline">
                <input type="text" name="panduan_num" id="panduan_num" class="layui-input" value="<%=detail.panduan_num%>" lay-verify="panduan_num">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">判断题分值</label>
              <div class="layui-input-inline">
                <input type="text" name="panduan_fenzhi" id="panduan_fenzhi" class="layui-input" value="<%=detail.panduan_fenzhi%>" lay-verify="panduan_fenzhi">
              </div>
              <div class="layui-form-mid layui-word-aux">分</div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">可考次数</label>
              <div class="layui-input-inline">
                <input type="text" name="ckcs" id="ckcs" class="layui-input" lay-verify="ckcs" style="color: red;" value="<%=detail.ckcs%>" lay-verify="ckcs">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">试卷总分</label>
              <div class="layui-input-inline">
                <input type="text" name="sjfz" id="sjfz" class="layui-input" lay-verify="sjfz" value='<%=detail.zongfen%>' style="color: red;" disabled="">
              </div>
              <div class="layui-form-mid layui-word-aux">分</div>
            </div>
          </div>
          
          <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">模块\题型</label>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="" id="mkdanxuan" placeholder="" class="layui-input" lay-verify="" value='单选' disabled="" style="color:red;font-weight: bold;">
                </div>
                <div class="layui-form-mid">+</div>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="" id="mkduoxuan" placeholder="" class="layui-input" lay-verify="" value='多选' disabled="" style="color:red;font-weight: bold;">
                </div>
                <div class="layui-form-mid">+</div>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="" id="mkpanduan" placeholder="" class="layui-input" lay-verify="" value='判断' disabled="" style="color:red;font-weight: bold;">
                </div>
                <div class="layui-form-mid">=</div>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="" id="mkzongfen" placeholder="" class="layui-input" lay-verify="" value='模块总分' disabled="" style="color:red;font-weight: bold;">
                </div>
              </div>
          </div>

          <%detail.per_of_modal.forEach(function(item,index){%>
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label"><%=item.name%></label>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="<%=index+1%>" id="<%=index+1%>" placeholder="单选" class="layui-input" lay-verify="<%=index+1%>" value='<%=item.num_danxuan%>'>
                </div>
                <div class="layui-form-mid">+</div>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="<%=index+1%><%=index%>" id="<%=index+1%><%=index%>" placeholder="多选" class="layui-input" lay-verify="<%=index+1%><%=index%>" value='<%=item.num_duoxuan%>'>
                </div>
                <div class="layui-form-mid">+</div>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="<%=index+1%><%=index%><%=index%>" id="<%=index+1%><%=index%><%=index%>" placeholder="判断" class="layui-input" lay-verify="<%=index+1%><%=index%><%=index%>" value='<%=item.num_panduan%>'>
                </div>
                <div class="layui-form-mid">=</div>
                <div class="layui-input-inline" style="width: 100px;">
                  <input type="text" name="<%=index+1%><%=index%><%=index%><%=index%>" id="<%=index+1%><%=index%><%=index%><%=index%>" placeholder="模块总分" class="layui-input" lay-verify="<%=index+1%><%=index%><%=index%><%=index%>" value='<%=item.mokuaizongfen%>' disabled="" style="color: red;">
                </div>
              </div>
            </div>
          <%})%>

          

          <div class="layui-form-item">
            <label class="layui-form-label">考试链接</label>
            <div class="layui-input-block">
              <input type="text" name="kslianjie" id="kslianjie" class="layui-input" value="<%=detail.kslianjie%>" disabled>
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" lay-submit="" lay-filter="tijiao">确认修改</button>
              <!-- <button type="reset" class="layui-btn layui-btn-primary">重置</button> -->
            </div>
          </div>
          
        </form>
      </div>
    </fieldset>

<script src="/dxxxhjs/javascripts/jquery-3.1.1.js"></script>
<script src="/dxxxhjs/javascripts/layui.js"></script>
<script>
'use strict'
$(function(){
  'use strict'
  layui.use(['layer','form'], function(){
    let layer = layui.layer,
        form = layui.form;
    var all_percent = 0,
      temp_choose = ''
  //自定义验证规则  
        form.verify({ 
          <%detail.per_of_modal.forEach(function(item,index){%>
            <%=index+1%>:function(value){
              if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                    return '必须是大于0的整数';  
                  }
            },
            <%=index+1%><%=index%>:function(value){
              if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                    return '必须是大于0的整数';  
                  }
            },
            <%=index+1%><%=index%><%=index%>:function(value){
              if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                    return '必须是大于0的整数';  
                  }
            },
            <%})%> 
              ksshijian: function(value){  
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '考试时间必须是大于0的整数';  
                }  
              } ,
              // sjfs : function(value){
              //   if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              //     return '试卷份数必须是大于0的整数';  
              //   }  
              // },
              danxuan_num: function(value){  
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '题目数量必须是大于0的整数';  
                }  
              } ,
              duoxuan_num: function(value){  
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '题目数量必须是大于0的整数';  
                }  
              } ,
              panduan_num: function(value){  
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '题目数量必须是大于0的整数';  
                }  
              } ,
              danxuan_fenzhi: function(value){
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '分值必须是大于0的整数';  
                } 
              },
              duoxuan_fenzhi: function(value){
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '分值必须是大于0的整数';  
                } 
              },
              panduan_fenzhi: function(value){
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '分值必须是大于0的整数';  
                } 
              },
              ckcs: function(value){
                if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
                  return '可考次数必须是大于0的整数';  
                } 
              }
        });
  var temp_choose_1='',temp_choose_2='',temp_choose_3='',temp_mokuai='';
  $('input').on('input propertychange',function(data){
          let temp1 = $('#danxuan_fenzhi').val() ? $('#danxuan_fenzhi').val() : 0,
              temp2 = $('#danxuan_num').val() ? $('#danxuan_num').val() : 0,
              temp3 = temp1 * temp2,
              temp4 = $('#duoxuan_fenzhi').val() ? $('#duoxuan_fenzhi').val() : 0,
              temp5 = $('#duoxuan_num').val() ? $('#duoxuan_num').val() : 0,
              temp6 = temp4 * temp5,
              temp7 = $('#panduan_fenzhi').val() ? $('#panduan_fenzhi').val() : 0,
              temp8 = $('#panduan_num').val() ? $('#panduan_num').val() : 0,
              temp9 = temp7 * temp8
          let sjfz = temp3 + temp6 + temp9
          console.log('试卷分值-->',sjfz)
          console.log('sjsz-->',$('#sjfz').attr("value"))
          $('#sjfz').attr("value",sjfz)
          let all_percent_1 = 0,mokuaizongfen = 0
          var mkdanxuan = 0,mkduoxuan = 0,mkpanduan = 0,mkzongfen = 0

          <%for(let i=0;i<detail.per_of_modal.length;i++){%>
            //获取每个模块总分
            temp_choose_1 = '#' + <%=i+1%>
            console.log('模块单选选择器-->',temp_choose_1)
            temp_choose_2 = '#' + <%=i+1%><%=i%>
            console.log('模块多选选择器-->',temp_choose_2)
            temp_choose_3 = '#' + <%=i+1%><%=i%><%=i%>
            console.log('模块判断选择器-->',temp_choose_3)
            temp_mokuai = '#' + <%=i+1%><%=i%><%=i%><%=i%>
            if($(temp_choose_1).val() && $(temp_choose_2).val() && $(temp_choose_3).val()){
              mokuaizongfen = parseInt($(temp_choose_1).val()*$('#danxuan_fenzhi').val())+parseInt($(temp_choose_2).val()*$('#duoxuan_fenzhi').val())+parseInt($(temp_choose_3).val()*$('#panduan_fenzhi').val())
              console.log('模块总分-->',mokuaizongfen)
              $(temp_mokuai).attr("value",mokuaizongfen)
              mkzongfen += mokuaizongfen
              $(temp_mokuai).attr("value",mokuaizongfen)
              $('#mkzongfen').attr("value",'总分：'+mkzongfen)
            }else{
              console.log('还没填写完整')
            }
            if($(temp_choose_1).val()){
              mkdanxuan += parseInt($(temp_choose_1).val())
              $('#mkdanxuan').attr("value",'单选：'+mkdanxuan)
            }
            if($(temp_choose_2).val()){
              mkduoxuan += parseInt($(temp_choose_2).val())
              $('#mkduoxuan').attr("value",'多选：'+mkduoxuan)
            }
            if($(temp_choose_3).val()){
              mkpanduan += parseInt($(temp_choose_3).val())
              $('#mkpanduan').attr("value",'判断：'+mkpanduan)
            }
          <%}%>
          
          //$('#all_percent').attr("value",all_percent_1)
  })//input
  //监听提交
        form.on('submit(tijiao)', function(data){
          let temp1 = $('#danxuan_fenzhi').val() * $('#danxuan_num').val(),
              temp2 = $('#duoxuan_num').val() * $('#duoxuan_fenzhi').val(),
              temp3 = $('#panduan_num').val() * $('#panduan_fenzhi').val()
          if((temp1+temp2+temp3)!==100){
            layer.open({
                  title: '提示',
                  content: '试题总分不是100分，请检查'
                }); 
            return false;
          }

          //获取所有的值
          //获取所有的值
          let ksname = $('#ksname').val(),
              _id = '<%=detail._id%>',
              //ksriqi = $('#ksriqi').val(),
              ksshijian = $('#ksshijian').val(),
              danxuan_fenzhi = $('#danxuan_fenzhi').val(),
              danxuan_num = $('#danxuan_num').val(),
              duoxuan_fenzhi = $('#duoxuan_fenzhi').val(),
              duoxuan_num = $('#duoxuan_num').val(),
              panduan_fenzhi = $('#panduan_fenzhi').val(),
              panduan_num = $('#panduan_num').val(),
              ckcs = $('#ckcs').val(),
              sjfs = $('#sjfs option:selected').val(),
              youxiao = $('#youxiao option:selected').val(),
              dangqian = $('#dangqian option:selected').val(),
              //all_percent = $('#all_percent').val(),
              obj = {},
              tem_arr = [],
              tem_choose = ''

          let te_danxuan = 0,
              te_duoxuan = 0,
              te_panduan = 0

          <%detail.per_of_modal.forEach(function(item,index){%>
              obj.id = <%=index%>
              obj.name = '<%=item.name%>'
              obj.danxuan = parseInt($('#' + (<%=index%>+1)).val())
              obj.duoxuan = parseInt($('#' + (<%=index%>+1) + <%=index%>).val())
              obj.panduan = parseInt($('#' + (<%=index%>+1)+ <%=index%>+ <%=index%>).val())
              obj.mokuaizongfen = parseInt($('#' + (<%=index%>+1)+ <%=index%>+ <%=index%>+ <%=index%>).val())
              tem_arr.push(obj)
              te_danxuan += parseInt($('#' + (<%=index%>+1)).val())
              te_duoxuan += parseInt($('#' + (<%=index%>+1) + <%=index%>).val())
              te_panduan += parseInt($('#' + (<%=index%>+1)+ <%=index%>+ <%=index%>).val())
              obj = {}
          <%})%>

          console.log('te_danxuan-->',te_danxuan)
          console.log('te_duoxuan-->',te_danxuan)
          console.log('te_panduan-->',te_panduan)
          //console.log('tem_arr-->',tem_arr)
          //return false
          if(te_danxuan!=$('#danxuan_num').val()){
            if(te_danxuan>parseInt($('#danxuan_num').val())){
              layer.open({
                  title: '提示',
                  content: '模块单选题超出设置，请检查',
                  end:function(){}                 
              }); 
              return false
            }else{
              layer.open({
                  title: '提示',
                  content: '模块单选题少于设置，请检查',
                  end:function(){}
                }); 
              return false
            }
          }
          if(te_duoxuan!=$('#duoxuan_num').val()){
            if(te_danxuan>parseInt($('#duoxuan_num').val())){
              layer.open({
                  title: '提示',
                  content: '模块多选题超出设置，请检查',
                  end:function(){}                 
              }); 
              return false
            }else{
              layer.open({
                  title: '提示',
                  content: '模块多选题少于设置，请检查',
                  end:function(){}
                }); 
              return false
            }
          }
          if(te_panduan!=$('#panduan_num').val()){
            if(te_panduan>parseInt($('#panduan_num').val())){
              layer.open({
                  title: '提示',
                  content: '模块判断题超出设置，请检查',
                  end:function(){}                 
              }); 
              return false
            }else{
              layer.open({
                  title: '提示',
                  content: '模块判断题少于设置，请检查',
                  end:function(){}
                }); 
              return false
            }
          }
          //console.log('tem_arr-->',tem_arr)
          $.ajax({
            url:'/dxxxhjs/manage/editsj',
            method:'post',
            data:{
              _id : _id,
              ksname : ksname,
              //ksriqi : ksriqi,
              ksshijian : ksshijian,
              danxuan_fenzhi : danxuan_fenzhi,
              danxuan_num : danxuan_num,
              duoxuan_fenzhi : duoxuan_fenzhi,
              duoxuan_num : duoxuan_num,
              panduan_fenzhi : panduan_fenzhi,
              panduan_num : panduan_num,
              modal_arr : JSON.stringify(tem_arr),
              ckcs : ckcs,
              youxiao : youxiao,
              dangqian : dangqian,
              sjfs : sjfs

            },
            success:function(res){
              if(res.code === 0){
                console.log(res.msg)
                layer.open({
                  title: '提示',
                  content: '修改成功',
                  end:function(){
                    parent.parent.layer.closeAll()
                    //layer.closeAll('iframe')
                  }
                }); 

              }else{
                layer.open({
                  title: '提示',
                  content: '修改出现问题，请反馈',
                  end:function(){
                    parent.parent.layer.closeAll()
                    //layer.closeAll('iframe')
                  }
                }); 
              }
            },
            error:function(err){
              console.log('delete err',err)
            }
          }) 
          return false
        })
  });
})

</script>
  </body>
</html>
