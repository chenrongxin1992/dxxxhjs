  <div class="col-md-3 col-sm-12 col-xs-12">
    <fieldset class="layui-elem-field">
      <legend>试卷设置</legend>
      <div class="layui-field-box">
        <form class="layui-form layui-form-pane" action="" id="first_step">
          <div class="layui-form-item">
            <div class="layui-form-item">
              <label class="layui-form-label label_big">考试主题</label>
              <div class="layui-input-inline">
                <input type="text" name="ksname" id="ksname" class="layui-input" placeholder="如党章测试" lay-verify="ksname">
              </div>
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-form-item">
              <label class="layui-form-label label_big">考试日期</label>
              <div class="layui-input-inline">
                <input type="text" name="ksriqi" id="ksriqi" class="layui-input" placeholder="yyyy-MM-dd" lay-verify="date">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">考试时间</label>
              <div class="layui-input-inline">
                <input type="text" name="ksshijian" id="ksshijian" class="layui-input" placeholder="单位为分钟" lay-verify="ksshijian">
              </div>
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label label_big">单选题分值</label>
              <div class="layui-input-inline">
                <input type="text" name="danxuan_fenzhi" id="danxuan_fenzhi" class="layui-input" placeholder="填写每道单选题分值" lay-verify="danxuan_fenzhi">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">单选题道数</label>
              <div class="layui-input-inline">
                <input type="text" name="danxuan_num" id="danxuan_num" class="layui-input" placeholder="填写单选题道数" lay-verify="danxuan_num">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">多选题分值</label>
              <div class="layui-input-inline">
                <input type="text" name="duoxuan_fenzhi" id="duoxuan_fenzhi" class="layui-input" placeholder="填写每道多选题分值" lay-verify="duoxuan_fenzhi">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">多选题道数</label>
              <div class="layui-input-inline">
                <input type="text" name="duoxuan_num" id="duoxuan_num" class="layui-input" placeholder="填写多选题道数" lay-verify="pandaun_num">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">判断题分值</label>
              <div class="layui-input-inline">
                <input type="text" name="panduan_fenzhi" id="panduan_fenzhi" class="layui-input" placeholder="填写每道判断题分值" lay-verify="panduan_fenzhi">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">判断题道数</label>
              <div class="layui-input-inline">
                <input type="text" name="panduan_num" id="panduan_num" class="layui-input" placeholder="填写判断题道数" lay-verify="panduan_num">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label label_big">试卷总分</label>
              <div class="layui-input-inline">
                <input type="text" name="sjfz" id="sjfz" class="layui-input" disabled style="color:red;" value='0'>
              </div>
            </div>
          </div>
          
          <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" lay-submit="" lay-filter="tijiao">提交</button>
              <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
          </div>
        </form>
      </div>
    </fieldset>
  </div>

  <div class="col-md-9 col-sm-12 col-xs-12">
    <fieldset class="layui-elem-field">
      <legend>试卷列表</legend>
        <table id="sjlb_tb" lay-filter="sjlb_table"></table>
    </fieldset>
  </div>

  <script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="edit" style="color:#fff;">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" style="color:#fff;">删除</a>
  </script>

<script>
'use strict'
$(function(){
  layui.use(['form', 'laydate','layer','table'], function(){
    let laydate = layui.laydate,
        layer = layui.layer,
        form = layui.form,
        table = layui.table

    let date = new Date(),
        year = date.getFullYear(),
        month = date.getMonth(),
        day = date.getDay()
        date = year + '-' + month + '-' + day
    //日期
    laydate.render({
      elem: '#ksriqi'
      ,min: date
      ,max: '2020-01-01'
    });

    //自定义验证规则  
    form.verify({  
          ksshijian: function(value){  
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '考试时间必须是大于0的整数';  
            }  
          } ,
          danxuan_num: function(value){  
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '题目数量必须是大于0的整数';  
            }  
          } ,
          duoxuan_num: function(value){  
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '题目数量必须是大于0的整数';  
            }  
          } ,
          panduan_num: function(value){  
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '题目数量必须是大于0的整数';  
            }  
          } ,
          danxuan_fenzhi: function(value){
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '分值必须是大于0的整数';  
            } 
          },
          duoxuan_fenzhi: function(value){
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '分值必须是大于0的整数';  
            } 
          },
          panduan_fenzhi: function(value){
            if(!(/^(0|[1-9][0-9]*)$/.test(value))){  
              return '分值必须是大于0的整数';  
            } 
          }
    });  

    $('input').on('input propertychange',function(data){
      let temp1 = $('#danxuan_fenzhi').val() ? $('#danxuan_fenzhi').val() : 0,
          temp2 = $('#danxuan_num').val() ? $('#danxuan_num').val() : 0,
          temp3 = temp1 * temp2,
          temp4 = $('#duoxuan_fenzhi').val() ? $('#duoxuan_fenzhi').val() : 0,
          temp5 = $('#duoxuan_num').val() ? $('#duoxuan_num').val() : 0,
          temp6 = temp4 * temp5,
          temp7 = $('#panduan_fenzhi').val() ? $('#panduan_fenzhi').val() : 0,
          temp8 = $('#panduan_num').val() ? $('#panduan_num').val() : 0,
          temp9 = temp7 * temp8
      let sjfz = temp3 + temp6 + temp9
      console.log('试卷分值-->',sjfz)
      $('#sjfz').attr("value",sjfz)
    })


    //监听提交
    form.on('submit(tijiao)', function(data){
      let temp1 = $('#danxuan_fenzhi').val() * $('#danxuan_num').val(),
          temp2 = $('#duoxuan_num').val() * $('#duoxuan_fenzhi').val(),
          temp3 = $('#panduan_num').val() * $('#panduan_fenzhi').val()
      if((temp1+temp2+temp3)!==100){
        layer.open({
              title: '提示',
              content: '试题总分不是100分，请检查'
            }); 
        return false;
      }
      $.ajax({
        url:'manage/sjsz',
        method:'POST',
        data:{
          ksname:$('#ksname').val(),
          ksriqi:$('#ksriqi').val(),
          ksshijian:$('#ksshijian').val(),
          danxuan_num:$('#danxuan_num').val(),
          duoxuan_num:$('#duoxuan_num').val(),
          panduan_num:$('#panduan_num').val(),
          danxuan_fenzhi:$('#danxuan_fenzhi').val(),
          duoxuan_fenzhi:$('#duoxuan_fenzhi').val(),
          panduan_fenzhi:$('#panduan_fenzhi').val()
        },
        success:function(res){
          if(res.code === 0){
            layer.open({
              title: '提交结果',
              content: '设置成功，你可在右侧查看试卷设置信息'
            });  
            table.reload('reload_tb', {
              where: {
                //查询条件
              }
            });
          }
        },//success
        error:function(err){
          console.log('err-->',err.stack)
        }
      });//ajax
      return false;
    })//form

    //执行实例
    table.render({
      elem: '#sjlb_tb'
      ,height: 'full-200'//高度最大化
      ,cellMinWidth: 50//列宽自动分配
      ,url: '/manage/sjlb_data' //数据接口
      ,page: true //开启分页
      ,id: 'reload_tb'
      ,cols:  [[ //标题栏
         {field: 'id', title: 'id', align: 'center'} //rowspan即纵向跨越的单元格数
        ,{field: 'ksname', title: '试卷主题', align: 'center'} //rowspan即纵向跨越的单元格数
        ,{field: 'ksriqi', title: '考试日期', align: 'center'}
        ,{field: 'ksshijian', title: '考试时间(分钟)', align: 'center'}
        ,{field: 'danxuan_num', title: '单选题', align: 'center'}
        ,{field: 'duoxuan_num', title: '多选题', align: 'center'}
        ,{field: 'panduan_num', title: '判断题', align: 'center'}
        ,{field: 'kslianjie', title: '考试链接', align: 'center'}
        ,{align: 'center',field:'caozuo', title: '操作', width:180,toolbar:"#toolbar" ,rowspan: 2}
      ]]
    })//table

    //监听工具条
    table.on('tool(sjlb_table)', function(obj){
      console.log('obj-->',obj)
      let data = obj.data;
      console.log('工具条监听-->',data)
      if(obj.event === 'detail'){
        console.log('监听详情-->',data.catid)
        console.log('能取到_id吗-->',data._id)
        //layer.msg('ID：'+ data.catid + ' 的查看操作');
         let if_index = layer.open({
            type: 2,
            title: '查看',
            shadeClose: true,
            shade: false,
            maxmin: true, //开启最大化最小化按钮
            area: ['900px', '600px'],
            content: '/manage/iframe_mb?_id=' + data._id
          }); 
          layer.iframeAuto(if_index);
      } 
      else if(obj.event === 'del'){
        console.log('监听删除-->',data._id)
        layer.confirm('确定要删除该条数据吗?', function(index){
          console.log('删除index-->',index)
          $.ajax({
            url:'/manage/delete_sjlbitem',
            method:'post',
            data:{
              _id:data._id
            },
            success:function(res){
              if(res.code === 0){
                console.log(res.msg)
                obj.del()
                layer.close(index);
              }else{
                console.log('删除失败')
              }
            },
            error:function(err){
              console.log('delete err',err)
            }
          }) 
        });
      } 
      else if(obj.event === 'edit'){
        console.log('编辑-->',JSON.stringify(data))
        //layer.alert('编辑行：<br>'+ JSON.stringify(data))
        let if_index = layer.open({
            skin: 'layui-layer-molv',
            type: 2,
            title: '查看',
            shadeClose: false,
            shade: [0.8, '#393D49'],
            scrollbar: false,
            maxmin: true, //开启最大化最小化按钮
            area: ['900px', '600px'],
            content: '/manage/iframe_mbbj?_id=' + data._id
          }); 
        layer.iframeAuto(if_index);
      }
    });//工具条
  });
})
</script>
